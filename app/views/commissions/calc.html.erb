<h3><span class="badge badge-success pull-right"><%= @agent.id %></span><%= @agent.name %></h3>
<h4>Commission for period <%= format_period :mk %></h4>

<div class='table-responsive'>
  <table class='table table-striped table-condensed'>
    <thead>
      <tr>
        <th>Terminal</th>
        <th>id</th>
        <th>game</th>
        <th style='text-align: right'>sales</th>
        <th style='text-align: center'>%</th>
        <th style='text-align: right'>commission</th>
      </tr>
    </thead>
    <% total_sales = 0 %>
    <% total_commission = 0 %>
    <% @terminals.each do |t| %>
      <tbody>
        <tr>
          <td colspan='6'><%= t.id %> <%= t.name %></td>
        </tr>
        <% sales = terminal_sales_for_period(t.id) %>
        <% sales.each do |s| %>
          <tr>
            <td></td>
            <td style='text-align: center'><%= s.game_id %></td>
            <td><%= s.game_name %></td>
            <td style='text-align: right'>
              <%= number_to_currency s.game_sales, precision: 2, unit: '' %></td>
            <td style='text-align: center'><%= (s.perc*100).to_i %>%</td>
            <td style='text-align: right'>
              <%= number_to_currency s.perc*s.game_sales, precision: 2, unit: '' %></td>
          </tr>
        <% end %>
        <tr>
          <td colspan='4' style='text-align: right'>
            <strong>
              <% total_sales += sales.inject(0) {|t, s| t + s.game_sales} %>
              <%= number_to_currency sales.inject(0) {|t, s| t + s.game_sales},
                  precision: 2, unit: '' %>
            </strong>
          </td>
          <td colspan='2' style='text-align: right'>
            <strong>
              <% total_commission += sales.inject(0) {|t, s| t + s.game_sales * s.perc} %>
              <%= number_to_currency sales.inject(0) {|t, s| t + s.game_sales * s.perc},
                  precision: 2, unit: '' %>
            </strong>
          </td>
        </tr>
      </tbody>
    <% end %>
    <tbody>
      <tr>
        <td colspan='4' style='text-align: right'>
          <strong>
            <%= number_to_currency total_sales, precision: 2, unit: '' %>
          </strong>
        </td>
        <td colspan='2' style='text-align: right'>
          <strong>
            <%= number_to_currency total_commission, precision: 2, unit: '' %>
          </strong>
        </td>
      </tr>
    </tbody>
  </table>
</div>
